# HU-EP7-001: Login de usuario con usuario y contraseña

## Formato estándar

Como **operador o administrador**, quiero **iniciar sesión con mi usuario y contraseña** para **acceder al sistema y realizar las operaciones según mi rol**.

---

## Descripción

El sistema debe permitir a los usuarios autenticarse mediante un nombre de usuario y contraseña. Una vez autenticado, el usuario debe recibir un token de acceso que le permita realizar operaciones según su rol (Administrador u Operador).

**Contexto de negocio:**
- Los operadores necesitan acceso rápido desde dispositivos móviles en el punto de venta
- Los administradores pueden acceder desde cualquier dispositivo
- La seguridad es crítica para proteger los datos de ventas e inventario
- El sistema debe mantener la sesión activa durante un período razonable

**Flujo de uso:**
1. Usuario accede a la pantalla de login
2. Ingresa su nombre de usuario y contraseña
3. Sistema valida las credenciales
4. Si son correctas, genera token JWT y redirige al dashboard según rol
5. Si son incorrectas, muestra mensaje de error

---

## Criterios de Aceptación

### Escenario 1: Login exitoso como Administrador
**Dado que** soy un usuario administrador con credenciales válidas  
**Cuando** ingreso mi nombre de usuario y contraseña correctos  
**Entonces** el sistema me autentica exitosamente  
**Y** recibo un token JWT válido  
**Y** soy redirigido al dashboard de administrador  
**Y** puedo acceder a todas las funcionalidades del sistema

### Escenario 2: Login exitoso como Operador
**Dado que** soy un operador con credenciales válidas  
**Cuando** ingreso mi nombre de usuario y contraseña correctos  
**Entonces** el sistema me autentica exitosamente  
**Y** recibo un token JWT válido  
**Y** soy redirigido al dashboard de operador  
**Y** solo puedo acceder a los puntos de venta asignados

### Escenario 3: Credenciales incorrectas
**Dado que** soy un usuario del sistema  
**Cuando** ingreso credenciales incorrectas (usuario o contraseña inválidos)  
**Entonces** el sistema muestra un mensaje de error genérico: "Usuario o contraseña incorrectos"  
**Y** no se genera ningún token  
**Y** permanezco en la pantalla de login

### Escenario 4: Usuario inactivo
**Dado que** soy un usuario con `IsActive = false`  
**Cuando** intento iniciar sesión con credenciales correctas  
**Entonces** el sistema muestra un mensaje de error: "Usuario desactivado. Contacte al administrador"  
**Y** no se genera ningún token  
**Y** no puedo acceder al sistema

### Escenario 5: Validación de campos requeridos
**Dado que** estoy en la pantalla de login  
**Cuando** intento iniciar sesión sin completar usuario o contraseña  
**Entonces** el sistema muestra mensajes de validación indicando los campos requeridos  
**Y** no se realiza ninguna petición al servidor

---

## Notas adicionales

- **Seguridad:**
  - Las contraseñas deben almacenarse con hash BCrypt (nunca en texto plano)
  - Implementar rate limiting para prevenir ataques de fuerza bruta (máx 5 intentos en 15 minutos)
  - El token JWT debe tener un tiempo de expiración razonable (ej: 8 horas)
  - Implementar refresh token para renovar la sesión sin requerir login nuevamente

- **UX:**
  - Mostrar indicador de carga durante la autenticación
  - En dispositivos móviles, recordar el último usuario (opcional, no la contraseña)
  - Permitir "Mostrar/Ocultar contraseña" para facilitar la entrada

- **Tecnología:**
  - Backend: JWT tokens con ASP.NET Core Identity o similar
  - Frontend: Almacenar token en httpOnly cookies o localStorage (evaluar seguridad)
  - Validar token en cada petición al backend

- **Auditoría:**
  - Registrar `LastLoginAt` en la tabla `User` al iniciar sesión exitosamente
  - Registrar intentos de login fallidos para análisis de seguridad

---

## Tareas

1. **Backend - Dominio:**
   - Implementar servicio de autenticación (`IAuthenticationService`)
   - Implementar validación de credenciales contra base de datos
   - Implementar generación de tokens JWT

2. **Backend - API:**
   - Crear endpoint `POST /api/auth/login`
   - Validar entrada (usuario y contraseña requeridos)
   - Retornar token JWT y datos básicos del usuario (rol, nombre)
   - Implementar manejo de errores (credenciales inválidas, usuario inactivo)

3. **Backend - Seguridad:**
   - Configurar JWT en `Program.cs` o `Startup.cs`
   - Implementar rate limiting para endpoint de login
   - Configurar políticas de CORS si es necesario

4. **Frontend - UI:**
   - Crear componente de login (formulario con usuario y contraseña)
   - Implementar validación de campos en cliente
   - Mostrar mensajes de error apropiados
   - Implementar indicador de carga

5. **Frontend - Servicios:**
   - Crear servicio de autenticación (`AuthService`)
   - Implementar almacenamiento seguro del token
   - Implementar interceptor HTTP para incluir token en peticiones
   - Implementar redirección según rol después del login

6. **Testing:**
   - Tests unitarios para servicio de autenticación
   - Tests de integración para endpoint de login
   - Tests E2E para flujo completo de login

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de tener la tabla `User` creada en base de datos
  - Requiere configuración de JWT y seguridad
  - Base para todas las demás funcionalidades (alta prioridad)

