# HU-EP5-003: Consultar historial de devoluciones

**Estado:** ✅ Implementado

## Formato estándar

Como **administrador u operador**, quiero **consultar el historial de devoluciones** para **auditar devoluciones y analizar patrones por categoría**.

---

## Descripción

Muestra lista paginada de devoluciones con filtros por producto, punto de venta, fecha y categoría. Los operadores solo ven devoluciones de sus puntos de venta asignados, mientras los administradores ven todas las devoluciones.

---

## Criterios de Aceptación

### Escenario 1: Visualizar historial con filtros

**Dado que** existen devoluciones registradas  
**Cuando** consulto el historial con filtros opcionales  
**Entonces** veo lista paginada de devoluciones (máximo 50 por página) con:
- Fecha de devolución
- Producto (SKU y nombre)
- Cantidad devuelta
- Categoría de devolución
- Motivo (si existe)
- Valor total de la devolución (calculado)
- Punto de venta
- Usuario que registró la devolución

### Escenario 2: Filtrar por rango de fechas

**Dado que** especifico un rango de fechas  
**Entonces** veo solo devoluciones dentro de ese rango  
**Y** si no especifico rango, se muestran los últimos 30 días por defecto

### Escenario 3: Filtrar por categoría

**Dado que** filtro por categoría "Defectuoso"  
**Entonces** veo solo devoluciones con esa categoría  
**Y** puedo analizar patrones de defectos

### Escenario 4: Filtrar por producto

**Dado que** filtro por producto específico  
**Entonces** veo todas las devoluciones de ese producto  
**Y** puedo identificar productos problemáticos

### Escenario 5: Filtrar por punto de venta

**Dado que** filtro por punto de venta "Tienda Centro"  
**Entonces** veo solo devoluciones de ese POS

### Escenario 6: Operador ve solo sus puntos de venta

**Dado que** soy operador asignado a "Tienda Centro" y "Hotel Playa"  
**Cuando** consulto el historial sin filtrar por POS  
**Entonces** veo devoluciones de ambos puntos de venta asignados  
**Y** no veo devoluciones de otros puntos de venta

### Escenario 7: Ver detalles de devolución

**Dado que** selecciono una devolución del historial  
**Entonces** veo detalles completos:
- Información de la devolución (fecha, cantidad, categoría, motivo)
- Ventas asociadas (con cantidades y precios por venta)
- Valor total calculado
- Foto adjunta (si existe)
- Usuario que registró
- Referencia al movimiento de inventario

### Escenario 8: Calcular valor total de devolución

**Dado que** una devolución está asociada a 2 ventas:
- Venta A: 2 unidades a €100/ud
- Venta B: 1 unidad a €110/ud
**Entonces** el valor total se muestra como €310 (2×100 + 1×110)  
**Y** el formato es en euros (€) con locale es-ES

### Escenario 9: Paginación del historial

**Dado que** hay más de 50 devoluciones que cumplen los filtros  
**Entonces** se muestran 50 por página  
**Y** se incluye información de paginación (total, páginas, página actual)

---

## Datos de Salida (Respuesta API)

```json
{
  "returns": [
    {
      "id": "uuid",
      "returnDate": "2026-01-15T14:20:00Z",
      "product": {
        "id": "uuid",
        "sku": "ANI-ORO-18K-001",
        "name": "Anillo Oro 18K"
      },
      "quantity": 2,
      "returnCategory": "Defectuoso",
      "reason": "Producto rayado",
      "totalValue": 300.00,
      "pointOfSale": {
        "id": "uuid",
        "name": "Tienda Centro"
      },
      "registeredBy": {
        "id": "uuid",
        "name": "María López"
      },
      "hasPhoto": true
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 3,
    "totalCount": 125,
    "pageSize": 50
  }
}
```

---

## Tareas

1. Backend: Endpoint `GET /api/returns` con filtros y paginación
2. Backend: Endpoint `GET /api/returns/{id}` para detalles
3. Backend: Query que calcula valor total desde ReturnSale
4. Backend: Autorización (operador filtra por sus POS)
5. Frontend: Tabla de devoluciones con filtros
6. Frontend: Vista de detalle de devolución
7. Frontend: Navegación desde menú lateral

---

## Estimaciones y atributos de priorización

- **Puntos de historia:** 5
- **Prioridad:** Media
- **Dependencias:** HU-EP5-001 (Registro de devoluciones)
