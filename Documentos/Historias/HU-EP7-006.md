# HU-EP7-006: Control de acceso según rol y asignaciones

## Formato estándar

Como **sistema**, quiero **controlar el acceso a funcionalidades según el rol del usuario y sus asignaciones a puntos de venta** para **garantizar que cada usuario solo acceda a los recursos autorizados**.

---

## Descripción

El sistema debe implementar un sistema de control de acceso basado en roles (RBAC) y asignaciones a puntos de venta. Los administradores tienen acceso completo, mientras que los operadores solo pueden acceder a funcionalidades y datos de sus puntos de venta asignados.

**Contexto de negocio:**
- La seguridad es crítica para proteger datos de ventas e inventario
- Los operadores no deben poder ver o modificar datos de puntos de venta no asignados
- Los administradores necesitan acceso completo para gestión y reportes
- El control de acceso debe aplicarse tanto en frontend (UX) como en backend (seguridad)

**Ámbitos de control:**
1. **Autenticación:** Verificar que el usuario está autenticado
2. **Autorización por rol:** Verificar permisos según rol (Admin vs Operator)
3. **Autorización por asignación:** Verificar que operador tiene acceso al punto de venta específico
4. **Filtrado de datos:** Mostrar solo datos de puntos de venta asignados (para operadores)

---

## Criterios de Aceptación

### Escenario 1: Administrador accede a todas las funcionalidades
**Dado que** soy un usuario autenticado con rol Administrador  
**Cuando** accedo a cualquier funcionalidad del sistema  
**Entonces** tengo acceso completo sin restricciones  
**Y** puedo ver todos los puntos de venta  
**Y** puedo gestionar usuarios, productos, inventario, ventas, etc.

### Escenario 2: Operador accede solo a puntos de venta asignados
**Dado que** soy un operador autenticado  
**Y** estoy asignado a los puntos de venta A y B  
**Cuando** accedo a funcionalidades que requieren seleccionar punto de venta  
**Entonces** solo veo los puntos de venta A y B en las listas  
**Y** no puedo acceder a otros puntos de venta

### Escenario 3: Operador intenta acceder a punto de venta no asignado
**Dado que** soy un operador asignado solo al punto de venta A  
**Cuando** intento acceder directamente a datos del punto de venta B (mediante URL o API)  
**Entonces** el sistema rechaza el acceso  
**Y** muestra error 403 (Forbidden) o redirige a página autorizada  
**Y** no puedo ver ni modificar datos del punto de venta B

### Escenario 4: Operador registra venta en punto de venta asignado
**Dado que** soy un operador asignado al punto de venta A  
**Cuando** registro una venta seleccionando el punto de venta A  
**Entonces** el sistema valida que tengo acceso al punto de venta A  
**Y** permite registrar la venta exitosamente

### Escenario 5: Operador intenta registrar venta en punto de venta no asignado
**Dado que** soy un operador asignado solo al punto de venta A  
**Cuando** intento registrar una venta seleccionando el punto de venta B  
**Entonces** el sistema rechaza la operación  
**Y** muestra error: "No tiene acceso a este punto de venta"  
**Y** no se registra la venta

### Escenario 6: Operador consulta inventario solo de puntos de venta asignados
**Dado que** soy un operador asignado a los puntos de venta A y B  
**Cuando** consulto el inventario  
**Entonces** solo veo el stock de los puntos de venta A y B  
**Y** no veo stock de otros puntos de venta

### Escenario 7: Operador intenta acceder a gestión de usuarios
**Dado que** soy un operador (no administrador)  
**Cuando** intento acceder a la funcionalidad de gestión de usuarios  
**Entonces** el sistema oculta la funcionalidad en el menú (frontend)  
**Y** si accedo directamente (URL/API), muestra error 403 (Forbidden)

### Escenario 8: Usuario no autenticado intenta acceder
**Dado que** no estoy autenticado  
**Cuando** intento acceder a cualquier funcionalidad protegida  
**Entonces** el sistema redirige al login  
**Y** después del login, redirige a la página solicitada originalmente

### Escenario 9: Token expirado durante sesión
**Dado que** mi token JWT ha expirado  
**Cuando** intento realizar una operación  
**Entonces** el sistema detecta el token expirado  
**Y** redirige al login  
**Y** muestra mensaje: "Su sesión ha expirado. Por favor, inicie sesión nuevamente"

---

## Notas adicionales

- **Implementación en capas:**
  - **Frontend:** Ocultar/mostrar funcionalidades según rol (UX, no seguridad)
  - **Backend:** Validar siempre en API (seguridad real)
  - **Base de datos:** Filtros automáticos en consultas para operadores

- **Puntos de control:**
  - Middleware de autenticación (verificar token JWT)
  - Middleware de autorización (verificar rol)
  - Validación en endpoints específicos (verificar asignación a punto de venta)
  - Filtrado en consultas de datos (solo puntos de venta asignados)

- **Funcionalidades por rol:**

  **Administrador:**
  - Gestión de usuarios (crear, editar, asignar)
  - Gestión de puntos de venta
  - Gestión de métodos de pago
  - Gestión de productos
  - Gestión de inventario (todos los puntos de venta)
  - Registro de ventas (todos los puntos de venta)
  - Gestión de devoluciones
  - Consultas y reportes (todos los datos)

  **Operador:**
  - Registro de ventas (solo puntos de venta asignados)
  - Consulta de inventario (solo puntos de venta asignados)
  - Consulta de historial de ventas (solo puntos de venta asignados)
  - NO puede gestionar usuarios, puntos de venta, métodos de pago, productos

- **Seguridad:**
  - Nunca confiar solo en validaciones de frontend
  - Validar siempre en backend
  - Usar principios de "least privilege" (mínimo privilegio necesario)
  - Registrar intentos de acceso no autorizado (Fase 2)

---

## Tareas

1. **Backend - Middleware:**
   - Implementar middleware de autenticación JWT
   - Implementar middleware de autorización por roles
   - Configurar políticas de autorización en ASP.NET Core

2. **Backend - Servicios:**
   - Crear servicio de autorización (`IAuthorizationService`)
   - Implementar método para verificar acceso a punto de venta
   - Implementar método para obtener puntos de venta asignados de un operador

3. **Backend - API:**
   - Aplicar atributos `[Authorize]` y `[Authorize(Roles = "Admin")]` en endpoints
   - Validar acceso a punto de venta en endpoints que lo requieren
   - Filtrar consultas de datos según asignaciones (para operadores)

4. **Backend - Base de datos:**
   - Implementar filtros automáticos en consultas (solo puntos de venta asignados para operadores)
   - Optimizar consultas con joins a `UserPointOfSale` cuando sea necesario

5. **Frontend - Servicios:**
   - Implementar interceptor HTTP para incluir token en peticiones
   - Manejar respuestas 401 (no autenticado) y 403 (no autorizado)
   - Redirigir al login cuando el token expire

6. **Frontend - UI:**
   - Ocultar/mostrar elementos del menú según rol del usuario
   - Filtrar listas de puntos de venta según asignaciones (para operadores)
   - Mostrar mensajes de error apropiados para accesos denegados

7. **Testing:**
   - Tests de integración para middleware de autenticación/autorización
   - Tests de endpoints con diferentes roles
   - Tests de filtrado de datos según asignaciones
   - Tests de seguridad (intentos de acceso no autorizado)

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de HU-EP7-001 (login), HU-EP7-004 (asignaciones)
  - Requiere implementación transversal en todo el sistema
  - Crítica para seguridad del sistema
  - Debe implementarse antes o en paralelo con otras funcionalidades

