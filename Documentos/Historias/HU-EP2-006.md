# HU-EP2-006: Asignar/desasignar productos a puntos de venta

## Formato estándar

Como **administrador**, quiero **asignar productos del catálogo global a inventarios de puntos de venta específicos** para **controlar qué productos están disponibles en cada ubicación para los operadores**.

---

## Descripción

Permite al administrador asignar productos del catálogo global a los inventarios de puntos de venta específicos, creando registros en la tabla `Inventory` con cantidad inicial 0. Los productos asignados se vuelven visibles para los operadores del punto de venta correspondiente. También permite desasignar productos cuando ya no sean necesarios en una ubicación.

**Regla de negocio clave**: La presencia de un registro en `Inventory` (independientemente de la cantidad) determina que el producto está asignado al punto de venta y es visible para los operadores asignados.

---

## Criterios de Aceptación

### Escenario 1: Asignar producto a punto de venta
**Dado que** soy un administrador  
**Y** existe un producto "Anillo Oro" en el catálogo global  
**Y** el producto NO está asignado al "Punto de Venta A"  
**Cuando** asigno "Anillo Oro" al "Punto de Venta A"  
**Entonces** se crea un registro en `Inventory` con `Quantity = 0`  
**Y** el producto se vuelve visible para operadores asignados al "Punto de Venta A"  
**Y** se muestra mensaje: "Producto asignado exitosamente al punto de venta"

### Escenario 2: Asignación masiva de productos
**Dado que** soy un administrador  
**Y** selecciono múltiples productos (ej: 5 productos)  
**Cuando** los asigno al "Punto de Venta B"  
**Entonces** se crean 5 registros en `Inventory` con `Quantity = 0`  
**Y** todos los productos se vuelven visibles para operadores del POS B  
**Y** se muestra mensaje: "5 productos asignados exitosamente"

### Escenario 3: Producto ya asignado
**Dado que** un producto ya está asignado a un punto de venta  
**Cuando** intento asignarlo nuevamente al mismo punto de venta  
**Entonces** el sistema muestra mensaje: "El producto ya está asignado a este punto de venta"  
**Y** no se crea registro duplicado

### Escenario 4: Desasignar producto con cantidad 0
**Dado que** un producto está asignado al "Punto de Venta A" con `Quantity = 0`  
**Cuando** desasigno el producto  
**Entonces** el registro en `Inventory` se marca como inactivo (`IsActive = false`)  
**Y** el producto deja de ser visible para operadores del POS A  
**Y** se preserva el historial del registro para auditoría  
**Y** se muestra mensaje: "Producto desasignado exitosamente"

### Escenario 5: Intentar desasignar producto con cantidad > 0
**Dado que** un producto tiene `Quantity = 10` en el "Punto de Venta A"  
**Cuando** intento desasignarlo  
**Entonces** el sistema muestra error: "No se puede desasignar un producto con stock. Ajuste la cantidad a 0 primero."  
**Y** el producto sigue asignado al punto de venta

### Escenario 6: Visualizar productos asignados a un punto de venta
**Dado que** soy un administrador en la vista de asignación  
**Cuando** selecciono un punto de venta  
**Entonces** veo la lista de productos asignados a ese punto de venta  
**Y** veo la cantidad actual de cada producto  
**Y** puedo identificar productos con `Quantity = 0` con un indicador visual

### Escenario 7: Asignar producto inactivo
**Dado que** un producto está marcado como inactivo (`IsActive = false`)  
**Cuando** intento asignarlo a un punto de venta  
**Entonces** el sistema muestra error: "No se puede asignar un producto inactivo"  
**Y** no se crea el registro en `Inventory`

### Escenario 8: Reasignar producto previamente desasignado
**Dado que** un producto fue desasignado anteriormente (`IsActive = false` en Inventory)  
**Cuando** lo vuelvo a asignar al mismo punto de venta  
**Entonces** se reactiva el registro existente (`IsActive = true`)  
**Y** mantiene la cantidad anterior (o se puede resetear a 0 según diseño)  
**Y** se muestra mensaje: "Producto reasignado exitosamente"

---

## Tareas

1. Backend: Endpoint `POST /api/inventory/assign` para asignar productos (individual o masivo)
2. Backend: Endpoint `POST /api/inventory/unassign` para desasignar con validación de cantidad
3. Backend: Endpoint `GET /api/inventory/assigned?pointOfSaleId={id}` para listar asignados
4. Backend: Servicio de asignación con validaciones (producto activo, cantidad 0 para desasignación)
5. Backend: Lógica de soft delete (IsActive flag) en tabla Inventory
6. Frontend: Página de asignación con selector de POS y lista de productos
7. Frontend: Componente de selección múltiple de productos del catálogo
8. Frontend: Botón de asignación masiva
9. Frontend: Vista de productos asignados por POS con botón desasignar
10. Frontend: Validación y mensajes de confirmación para desasignación

---

## Estimaciones y atributos de priorización

- **Puntos de historia:** _Pendiente_
- **Prioridad:** **Alta** - Funcionalidad crítica para que operadores puedan ver productos
- **Dependencias:** HU-EP1-001 (productos deben existir en catálogo global), HU-EP8-001 (puntos de venta deben existir)

---

## Notas técnicas

### Estructura del registro Inventory
```
Inventory {
    Id: UUID
    ProductId: FK -> Product
    PointOfSaleId: FK -> PointOfSale
    Quantity: int (inicial = 0 en asignación)
    IsActive: bool (true = asignado, false = desasignado)
    CreatedAt: timestamp
    UpdatedAt: timestamp
}
```

### Campo IsActive
- **Propósito**: Implementar soft delete para preservar historial
- **true**: Producto asignado y visible para operadores
- **false**: Producto desasignado, no visible para operadores
- **Ventaja**: Permite auditoría y reasignación sin perder datos históricos

### Relación con otras historias
- **HU-EP2-001** (Import stock): Puede crear registros Inventory implícitamente (asignación + cantidad)
- **HU-EP2-004** (Ajuste manual): Solo funciona en productos ya asignados (IsActive=true)
- **HU-EP1-006, HU-EP1-007** (Catálogo/Búsqueda): Filtran productos basándose en registros Inventory activos

### Índice recomendado
```sql
CREATE INDEX IX_Inventory_PointOfSale_Product_Active 
ON Inventory(PointOfSaleId, ProductId) 
WHERE IsActive = true;
```

