# HU-EP7-002: Crear nuevo usuario

## Formato estándar

Como **administrador**, quiero **crear nuevos usuarios en el sistema** para **asignar operadores a puntos de venta y gestionar el acceso al sistema**.

---

## Descripción

El sistema debe permitir a los administradores crear nuevos usuarios con roles de Administrador u Operador. Al crear un usuario, se debe establecer su nombre de usuario, contraseña, nombre completo, email (opcional) y rol.

**Contexto de negocio:**
- Los administradores necesitan poder agregar nuevos operadores cuando se abren nuevos puntos de venta
- Los usuarios deben tener credenciales seguras desde el inicio
- El email es opcional pero útil para notificaciones futuras (Fase 2)
- Los usuarios nuevos deben estar activos por defecto

**Flujo de uso:**
1. Administrador accede a la sección de gestión de usuarios
2. Hace clic en "Crear nuevo usuario"
3. Completa el formulario con los datos del usuario
4. Selecciona el rol (Administrador u Operador)
5. Confirma la creación
6. El sistema crea el usuario y muestra confirmación

---

## Criterios de Aceptación

### Escenario 1: Crear operador exitosamente
**Dado que** soy un administrador autenticado  
**Cuando** creo un nuevo usuario con:
- Username único y válido
- Contraseña segura (mínimo 8 caracteres)
- Nombre y apellido
- Rol: Operador
- Email opcional

**Entonces** el sistema crea el usuario exitosamente  
**Y** la contraseña se almacena con hash BCrypt  
**Y** el usuario queda con `IsActive = true`  
**Y** se muestra mensaje de confirmación  
**Y** el usuario aparece en la lista de usuarios

### Escenario 2: Crear administrador exitosamente
**Dado que** soy un administrador autenticado  
**Cuando** creo un nuevo usuario con rol Administrador  
**Entonces** el sistema crea el usuario exitosamente  
**Y** el usuario tiene acceso completo al sistema  
**Y** no requiere asignación a puntos de venta

### Escenario 3: Username duplicado
**Dado que** existe un usuario con username "operador1"  
**Cuando** intento crear un nuevo usuario con el mismo username "operador1"  
**Entonces** el sistema muestra un error: "El nombre de usuario ya está en uso"  
**Y** no se crea el usuario  
**Y** puedo corregir el username e intentar nuevamente

### Escenario 4: Email duplicado (si se proporciona)
**Dado que** existe un usuario con email "usuario@ejemplo.com"  
**Cuando** intento crear un nuevo usuario con el mismo email  
**Entonces** el sistema muestra un error: "El email ya está registrado"  
**Y** no se crea el usuario

### Escenario 5: Validación de campos requeridos
**Dado que** estoy en el formulario de crear usuario  
**Cuando** intento crear un usuario sin completar campos obligatorios (username, contraseña, nombre, apellido, rol)  
**Entonces** el sistema muestra mensajes de validación indicando los campos requeridos  
**Y** no se crea el usuario

### Escenario 6: Contraseña débil
**Dado que** estoy creando un nuevo usuario  
**Cuando** ingreso una contraseña con menos de 8 caracteres o sin complejidad suficiente  
**Entonces** el sistema muestra un mensaje de validación: "La contraseña debe tener al menos 8 caracteres"  
**Y** no se crea el usuario hasta cumplir los requisitos

### Escenario 7: Usuario no autorizado
**Dado que** soy un operador (no administrador)  
**Cuando** intento acceder a la funcionalidad de crear usuario  
**Entonces** el sistema me muestra un error de acceso denegado  
**Y** no puedo crear usuarios

---

## Notas adicionales

- **Seguridad:**
  - Las contraseñas deben cumplir políticas de seguridad (mínimo 8 caracteres recomendado)
  - El hash de contraseña debe generarse con BCrypt antes de almacenar
  - Los administradores no deben poder ver las contraseñas de otros usuarios

- **Validaciones:**
  - Username: único, alfanumérico y guiones bajos, mínimo 3 caracteres
  - Email: formato válido si se proporciona, único si se proporciona
  - Contraseña: mínimo 8 caracteres (considerar requerir mayúsculas, números, símbolos)

- **UX:**
  - Mostrar indicador de fortaleza de contraseña en tiempo real
  - Permitir generar contraseña aleatoria segura (opcional)
  - Confirmar contraseña para evitar errores de tipeo

- **Datos por defecto:**
  - `IsActive = true` (usuario activo por defecto)
  - `CreatedAt = DateTime.UtcNow`
  - `UpdatedAt = DateTime.UtcNow`
  - `LastLoginAt = null` (hasta que inicie sesión por primera vez)

---

## Tareas

1. **Backend - Dominio:**
   - Implementar servicio de gestión de usuarios (`IUserService`)
   - Implementar validación de unicidad de username y email
   - Implementar hash de contraseña con BCrypt

2. **Backend - API:**
   - Crear endpoint `POST /api/users`
   - Validar entrada (campos requeridos, formato de email, fortaleza de contraseña)
   - Verificar permisos (solo administradores)
   - Retornar datos del usuario creado (sin contraseña)

3. **Backend - Base de datos:**
   - Asegurar constraint único en `User.Username`
   - Asegurar constraint único en `User.Email` (nullable)
   - Manejar excepciones de violación de constraints

4. **Frontend - UI:**
   - Crear formulario de creación de usuario
   - Implementar validación de campos en cliente
   - Mostrar indicador de fortaleza de contraseña
   - Campo de confirmación de contraseña
   - Selector de rol (Administrador/Operador)

5. **Frontend - Servicios:**
   - Crear servicio para gestión de usuarios (`UserService`)
   - Implementar llamada al endpoint de creación
   - Manejar errores (username duplicado, email duplicado)

6. **Testing:**
   - Tests unitarios para servicio de usuarios
   - Tests de integración para endpoint de creación
   - Tests de validación de campos
   - Tests de permisos (solo administradores)

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de HU-EP7-001 (login) para autenticación
  - Requiere tabla `User` en base de datos
  - Base para asignación de operadores a puntos de venta (HU-EP7-004)

