# HU-EP3-001: Registrar venta con reconocimiento de imagen

## Formato estándar

Como **operador**, quiero **registrar una venta usando reconocimiento de imagen** para **agilizar el proceso de registro y reducir errores en la identificación del producto**.

---

## Descripción

Permite registrar una venta capturando una foto del producto, procesándola con IA para obtener sugerencias, seleccionando el producto correcto, validando stock disponible, seleccionando método de pago y confirmando la venta. Incluye validación de stock y selección de método de pago como parte del proceso.

**Flujo completo:**
1. Capturar foto del producto
2. Procesar imagen con IA (3 sugerencias)
3. Seleccionar producto correcto
4. Validar stock disponible
5. Seleccionar método de pago (de los asignados al punto de venta)
6. Confirmar venta
7. Actualizar stock automáticamente

---

## Criterios de Aceptación

### Escenario 1: Venta exitosa con reconocimiento de imagen
**Dado que** soy un operador autenticado asignado a un punto de venta  
**Y** un producto tiene stock disponible  
**Y** el punto de venta tiene métodos de pago asignados  
**Cuando** capturo foto, selecciono producto de las sugerencias, valido stock y selecciono método de pago  
**Entonces** el sistema registra la venta exitosamente  
**Y** se crea registro en `Sale` con precio snapshot  
**Y** se guarda la foto en `SalePhoto`  
**Y** se crea movimiento en `InventoryMovement` tipo "Sale"  
**Y** el stock se reduce automáticamente

### Escenario 2: Stock insuficiente
**Dado que** un producto tiene stock 0  
**Cuando** intento registrar una venta de ese producto  
**Entonces** el sistema muestra error: "Stock insuficiente"  
**Y** no se registra la venta  
**Y** puedo cancelar o seleccionar otro producto

### Escenario 3: Método de pago no asignado
**Dado que** intento usar un método de pago no asignado al punto de venta  
**Cuando** selecciono ese método  
**Entonces** el sistema muestra error: "Este método de pago no está disponible en este punto de venta"  
**Y** solo muestra métodos asignados

### Escenario 4: Operador no asignado al punto de venta
**Dado que** intento registrar venta en un punto de venta no asignado  
**Cuando** selecciono ese punto de venta  
**Entonces** el sistema rechaza el acceso  
**Y** muestra error de autorización

### Escenario 5: Reconocimiento sin correspondencia fiable
**Dado que** la IA no encuentra correspondencia fiable (< 60% confianza)  
**Cuando** proceso la imagen  
**Entonces** el sistema muestra mensaje: "No se encontró correspondencia fiable"  
**Y** ofrece opciones: tomar otra foto o registrar venta manual

---

## Notas adicionales

- **Validaciones incluidas:**
  - Stock disponible antes de confirmar venta
  - Método de pago asignado al punto de venta
  - Operador asignado al punto de venta
  - Producto activo

- **Transacciones:** Usar transacciones para garantizar atomicidad (venta + movimiento de inventario)

- **Precio:** Se guarda snapshot del precio actual del producto en `Sale.Price`

---

## Tareas

1. Backend: Endpoint `POST /api/sales` con validaciones de stock y método de pago
2. Backend: Servicio compartido de validación de stock (`IStockValidationService`)
3. Backend: Servicio compartido de validación de método de pago (`IPaymentMethodValidationService`)
4. Backend: Transacción para venta + movimiento de inventario
5. Frontend: Flujo completo de venta con reconocimiento de imagen
6. Frontend: Integración con HU-EP4-001 (reconocimiento de imágenes)

---

## Estimaciones y atributos de priorización

- **Puntos de historia:** _Pendiente_
- **Dependencias:** HU-EP4-001, HU-EP1-002, HU-EP2-002, HU-EP6-002, HU-EP7-006

