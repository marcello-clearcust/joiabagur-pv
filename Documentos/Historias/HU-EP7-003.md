# HU-EP7-003: Editar usuario existente

## Formato estándar

Como **administrador**, quiero **editar información de usuarios existentes** para **actualizar sus datos, cambiar su rol o desactivarlos sin eliminarlos del sistema**.

---

## Descripción

El sistema debe permitir a los administradores modificar la información de usuarios existentes, incluyendo nombre, apellido, email, rol y estado activo/inactivo. La contraseña debe poder cambiarse por separado. Los usuarios no deben poder eliminarse físicamente para mantener integridad histórica.

**Contexto de negocio:**
- Los administradores necesitan actualizar información de usuarios cuando cambian datos personales
- Puede ser necesario cambiar el rol de un usuario (promover operador a administrador o viceversa)
- Desactivar usuarios es preferible a eliminarlos para mantener trazabilidad histórica
- Los usuarios deben poder cambiar su propia contraseña (historia separada, Fase 2)

**Flujo de uso:**
1. Administrador accede a la lista de usuarios
2. Selecciona un usuario para editar
3. Modifica los campos deseados
4. Confirma los cambios
5. El sistema actualiza el usuario y muestra confirmación

---

## Criterios de Aceptación

### Escenario 1: Editar información básica exitosamente
**Dado que** soy un administrador autenticado  
**Y** existe un usuario en el sistema  
**Cuando** edito su nombre, apellido o email  
**Entonces** el sistema actualiza el usuario exitosamente  
**Y** se actualiza el campo `UpdatedAt`  
**Y** se muestra mensaje de confirmación  
**Y** los cambios se reflejan en la lista de usuarios

### Escenario 2: Cambiar rol de usuario
**Dado que** existe un operador en el sistema  
**Cuando** cambio su rol a Administrador  
**Entonces** el sistema actualiza el rol exitosamente  
**Y** el usuario adquiere permisos de administrador  
**Y** si tenía asignaciones a puntos de venta, estas se mantienen pero ya no son necesarias

### Escenario 3: Desactivar usuario
**Dado que** existe un usuario activo en el sistema  
**Cuando** cambio su estado a inactivo (`IsActive = false`)  
**Entonces** el sistema actualiza el estado exitosamente  
**Y** el usuario no puede iniciar sesión  
**Y** el usuario aparece marcado como inactivo en la lista  
**Y** se registra la fecha de desactivación si aplica

### Escenario 4: Activar usuario previamente desactivado
**Dado que** existe un usuario inactivo en el sistema  
**Cuando** cambio su estado a activo (`IsActive = true`)  
**Entonces** el sistema actualiza el estado exitosamente  
**Y** el usuario puede iniciar sesión nuevamente  
**Y** el usuario aparece como activo en la lista

### Escenario 5: Email duplicado al editar
**Dado que** existen dos usuarios: "usuario1" con email "email1@ejemplo.com" y "usuario2" con email "email2@ejemplo.com"  
**Cuando** intento cambiar el email de "usuario1" a "email2@ejemplo.com"  
**Entonces** el sistema muestra un error: "El email ya está registrado"  
**Y** no se actualiza el usuario  
**Y** puedo corregir el email e intentar nuevamente

### Escenario 6: Validación de campos requeridos
**Dado que** estoy editando un usuario  
**Cuando** elimino campos obligatorios (nombre, apellido)  
**Entonces** el sistema muestra mensajes de validación  
**Y** no se actualiza el usuario hasta completar los campos requeridos

### Escenario 7: Usuario no autorizado
**Dado que** soy un operador (no administrador)  
**Cuando** intento acceder a la funcionalidad de editar usuario  
**Entonces** el sistema me muestra un error de acceso denegado  
**Y** no puedo editar usuarios

### Escenario 8: No permitir editar username
**Dado que** estoy editando un usuario  
**Cuando** intento cambiar el username  
**Entonces** el campo username está deshabilitado o no está presente en el formulario  
**Y** el sistema no permite cambiar el username (debe ser inmutable para mantener integridad)

---

## Notas adicionales

- **Restricciones:**
  - El `Username` no debe poder modificarse (inmutable para mantener integridad histórica)
  - Si se necesita cambiar username, crear nuevo usuario y desactivar el anterior
  - La contraseña se cambia mediante funcionalidad separada (no en esta historia)

- **Validaciones:**
  - Email: formato válido si se proporciona, único si se proporciona (excepto el mismo usuario)
  - Nombre y apellido: campos requeridos, no vacíos

- **Auditoría:**
  - Actualizar `UpdatedAt` automáticamente al modificar cualquier campo
  - Considerar registrar cambios de rol o estado en tabla de auditoría (Fase 2)

- **UX:**
  - Mostrar información actual del usuario antes de editar
  - Confirmar cambios importantes (cambio de rol, desactivación)
  - Mostrar advertencia si se desactiva un usuario que tiene ventas recientes

---

## Tareas

1. **Backend - Dominio:**
   - Extender servicio de gestión de usuarios (`IUserService`) con método `UpdateUser`
   - Implementar validación de unicidad de email (excluyendo el usuario actual)
   - Validar que el usuario existe antes de actualizar

2. **Backend - API:**
   - Crear endpoint `PUT /api/users/{userId}`
   - Validar entrada (campos requeridos, formato de email)
   - Verificar permisos (solo administradores)
   - Retornar datos del usuario actualizado (sin contraseña)

3. **Backend - Base de datos:**
   - Manejar excepciones de violación de constraints (email duplicado)
   - Actualizar `UpdatedAt` automáticamente mediante trigger o en código

4. **Frontend - UI:**
   - Crear formulario de edición de usuario (pre-poblado con datos actuales)
   - Campo username deshabilitado o no editable
   - Checkbox o toggle para `IsActive`
   - Selector de rol
   - Botón de confirmar cambios

5. **Frontend - Servicios:**
   - Extender servicio de usuarios con método `updateUser`
   - Implementar llamada al endpoint de actualización
   - Manejar errores (email duplicado, usuario no encontrado)

6. **Testing:**
   - Tests unitarios para servicio de actualización
   - Tests de integración para endpoint de actualización
   - Tests de validación de campos
   - Tests de permisos (solo administradores)
   - Tests de inmutabilidad de username

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de HU-EP7-001 (login) y HU-EP7-002 (crear usuario)
  - Requiere tabla `User` en base de datos
  - Relacionada con HU-EP7-004 (asignación de operadores)

