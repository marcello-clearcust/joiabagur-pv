# HU-EP5-001: Registrar devolución de producto vendido

**Estado:** ✅ Implementado

## Formato estándar

Como **administrador u operador**, quiero **registrar devoluciones de productos vendidos asociándolas a una o más ventas originales** para **incrementar el stock y mantener trazabilidad con las ventas originales**.

---

## Descripción

Permite registrar una devolución asociada a una o más ventas originales del mismo punto de venta, dentro de un período de 30 días. El sistema incrementa automáticamente el stock y genera un movimiento de inventario tipo "Return". Las devoluciones requieren una categoría obligatoria y permiten un motivo de texto libre opcional.

**Restricciones:**
- La devolución debe realizarse en el mismo punto de venta donde se realizó la venta original
- Solo se pueden devolver unidades de ventas realizadas en los últimos 30 días
- La cantidad a devolver no puede exceder la cantidad disponible (vendida - ya devuelta)
- Los operadores solo pueden registrar devoluciones en sus puntos de venta asignados

---

## Criterios de Aceptación

### Escenario 1: Devolución exitosa asociada a una venta

**Dado que** existe una venta registrada en los últimos 30 días  
**Y** hay unidades disponibles para devolución (no devueltas previamente)  
**Cuando** registro una devolución asociada a esa venta  
**Y** selecciono una categoría de devolución (obligatoria)  
**Entonces** se crea registro en `Return` con la cantidad total  
**Y** se crea registro en `ReturnSale` vinculando la devolución a la venta con precio snapshot  
**Y** se incrementa el stock del producto en el punto de venta  
**Y** se crea movimiento en `InventoryMovement` tipo "Return" (cantidad positiva)  
**Y** opcionalmente puedo registrar un motivo de texto libre

### Escenario 2: Devolución parcial de venta multi-unidad

**Dado que** existe una venta de 5 unidades  
**Cuando** registro una devolución de 2 unidades de esa venta  
**Entonces** se crea `Return` con Quantity = 2  
**Y** se crea `ReturnSale` con Quantity = 2 y precio snapshot de la venta  
**Y** la venta aún tiene 3 unidades disponibles para futuras devoluciones  
**Y** el stock se incrementa en 2

### Escenario 3: Devolución asociada a múltiples ventas

**Dado que** el cliente compró 2 unidades el lunes y 3 el martes del mismo producto  
**Y** quiere devolver 4 unidades  
**Cuando** registro la devolución seleccionando ambas ventas  
**Y** distribuyo las cantidades (ej: 2 de la primera venta, 2 de la segunda)  
**Entonces** se crea `Return` con Quantity = 4  
**Y** se crean 2 registros `ReturnSale` (uno por cada venta con sus cantidades y precios)  
**Y** el stock se incrementa en 4

### Escenario 4: Validar venta existente y dentro del período

**Dado que** intento asociar una devolución a una venta de hace más de 30 días  
**Entonces** la venta no aparece en la lista de ventas elegibles  
**Y** si no hay ventas elegibles, el sistema muestra: "No hay ventas elegibles para devolución en los últimos 30 días"

### Escenario 5: Validar cantidad disponible

**Dado que** una venta de 3 unidades ya tiene 2 unidades devueltas  
**Cuando** intento devolver 2 unidades más de esa venta  
**Entonces** el sistema muestra error: "Cantidad a devolver excede las unidades disponibles. Disponible: 1"  
**Y** no se registra la devolución

### Escenario 6: Devolución debe ser en el mismo punto de venta

**Dado que** la venta original fue en el POS "Tienda Centro"  
**Cuando** intento registrar la devolución en el POS "Hotel Playa"  
**Entonces** el sistema muestra error: "La devolución debe realizarse en el mismo punto de venta de la venta original"

### Escenario 7: Categoría de devolución obligatoria

**Dado que** registro una devolución  
**Cuando** no selecciono una categoría  
**Entonces** el sistema no permite enviar el formulario  
**Y** las categorías disponibles son: Defectuoso, Tamaño incorrecto, No satisfecho, Otro

### Escenario 8: Motivo de devolución opcional

**Dado que** registro una devolución  
**Cuando** ingreso un motivo de texto libre (ej: "Producto rayado en la parte trasera")  
**Entonces** el motivo se guarda en `Return.Reason` (máximo 500 caracteres)  
**Y** aparece en el historial de devoluciones

### Escenario 9: Foto opcional de devolución

**Dado que** registro una devolución  
**Cuando** adjunto una foto del producto (ej: foto del defecto)  
**Entonces** la foto se comprime (JPEG 80%, max 2MB)  
**Y** se crea registro en `ReturnPhoto`  
**Y** la foto es accesible en los detalles de la devolución

### Escenario 10: Operador en punto de venta asignado

**Dado que** soy operador asignado al POS "Tienda Centro"  
**Cuando** intento registrar una devolución en "Tienda Centro"  
**Entonces** el sistema me permite realizar la devolución  
**Y** solo veo ventas elegibles de ese punto de venta

### Escenario 11: Operador rechazado en punto de venta no asignado

**Dado que** soy operador NO asignado al POS "Hotel Playa"  
**Cuando** intento registrar una devolución en "Hotel Playa"  
**Entonces** el sistema devuelve 403 Forbidden  
**Y** el POS no aparece en mi lista de selección

---

## Datos de Entrada

| Campo | Tipo | Obligatorio | Validación |
|-------|------|-------------|------------|
| ProductId | UUID | Sí | Producto debe existir |
| PointOfSaleId | UUID | Sí | POS debe existir y ser accesible |
| Quantity | int | Sí | >= 1, <= cantidad disponible |
| ReturnCategory | enum | Sí | Defectuoso, TamañoIncorrecto, NoSatisfecho, Otro |
| Reason | string | No | Máximo 500 caracteres |
| SaleAssociations | array | Sí | Al menos una venta, suma de cantidades = Quantity |
| Photo | file | No | Imagen (JPG, PNG), max 5MB antes de compresión |

---

## Tareas

1. Backend: Endpoint `POST /api/returns` con validación de ventas elegibles
2. Backend: Endpoint `GET /api/returns/eligible-sales` para consultar ventas disponibles
3. Backend: Transacción para devolución + ReturnSale + movimiento de inventario
4. Backend: Servicio de compresión y almacenamiento de foto (reutilizar de ventas)
5. Frontend: Formulario de devolución con búsqueda de producto
6. Frontend: Componente de selección de ventas elegibles con cantidades
7. Frontend: Selector de categoría y campo de motivo
8. Frontend: Captura/carga de foto opcional

---

## Estimaciones y atributos de priorización

- **Puntos de historia:** 8
- **Prioridad:** Media
- **Dependencias:** 
  - HU-EP3-001, HU-EP3-002 (Registro de ventas)
  - HU-EP2-002 (Gestión de inventario)
  - HU-EP7-001 (Autenticación)
  - HU-EP8-001 (Puntos de venta)
