# HU-EP5-002: Buscar ventas elegibles para asociar devolución

**Estado:** ✅ Implementado

## Formato estándar

Como **administrador u operador**, quiero **buscar las ventas elegibles para asociar una devolución** para **seleccionar a qué venta(s) vincular la devolución y ver las cantidades disponibles**.

---

## Descripción

Permite consultar ventas elegibles para devolución por producto y punto de venta. El sistema muestra solo ventas de los últimos 30 días con unidades disponibles (no devueltas previamente), incluyendo precio unitario y cantidad disponible para cada venta.

**Criterios de elegibilidad:**
- Mismo producto que se quiere devolver
- Mismo punto de venta
- Venta realizada en los últimos 30 días
- Cantidad disponible > 0 (vendida - ya devuelta)

---

## Criterios de Aceptación

### Escenario 1: Consultar ventas elegibles

**Dado que** existen ventas del producto "Anillo Oro 18K" en "Tienda Centro" en los últimos 30 días  
**Cuando** consulto ventas elegibles para ese producto y punto de venta  
**Entonces** veo lista de ventas con:
- ID de venta
- Fecha de venta
- Cantidad original vendida
- Cantidad disponible para devolución
- Precio unitario
- Método de pago

### Escenario 2: Cálculo de cantidad disponible

**Dado que** una venta tiene Quantity = 5  
**Y** ya se han devuelto 2 unidades de esa venta en devoluciones previas  
**Entonces** la venta muestra disponibleParaDevolución = 3

### Escenario 3: Excluir ventas completamente devueltas

**Dado que** una venta de 2 unidades ya tiene todas las unidades devueltas  
**Entonces** esa venta NO aparece en la lista de ventas elegibles

### Escenario 4: Ordenar por fecha descendente

**Dado que** hay múltiples ventas elegibles  
**Entonces** las ventas se muestran ordenadas por fecha descendente (más recientes primero)

### Escenario 5: Sin ventas elegibles

**Dado que** el producto no tiene ventas en los últimos 30 días en el POS seleccionado  
**O** todas las ventas están completamente devueltas  
**Entonces** el sistema devuelve lista vacía  
**Y** muestra mensaje: "No hay ventas elegibles para devolución"

### Escenario 6: Filtro por punto de venta para operador

**Dado que** soy operador asignado solo a "Tienda Centro"  
**Cuando** consulto ventas elegibles  
**Entonces** solo veo ventas de "Tienda Centro"  
**Y** no puedo consultar ventas de otros puntos de venta

### Escenario 7: Visualizar detalles de venta

**Dado que** encuentro una venta elegible  
**Cuando** visualizo sus detalles  
**Entonces** veo:
- SKU del producto
- Nombre del producto
- Precio unitario (snapshot de la venta)
- Fecha y hora de la venta
- Cantidad original
- Cantidad ya devuelta
- Cantidad disponible
- Método de pago utilizado
- Operador que realizó la venta
- Foto de la venta (si existe)

---

## Datos de Salida (Respuesta API)

```json
{
  "eligibleSales": [
    {
      "saleId": "uuid",
      "saleDate": "2026-01-10T10:30:00Z",
      "quantity": 3,
      "alreadyReturned": 1,
      "availableForReturn": 2,
      "unitPrice": 150.00,
      "paymentMethod": "Efectivo",
      "operatorName": "Juan García",
      "hasPhoto": true
    }
  ],
  "totalAvailableForReturn": 5,
  "product": {
    "id": "uuid",
    "sku": "ANI-ORO-18K-001",
    "name": "Anillo Oro 18K"
  }
}
```

---

## Tareas

1. Backend: Endpoint `GET /api/returns/eligible-sales?productId={id}&pointOfSaleId={id}`
2. Backend: Query que calcula cantidad disponible por venta
3. Backend: Autorización (operador solo ve sus POS asignados)
4. Frontend: Componente de visualización de ventas elegibles
5. Frontend: Interfaz de selección con indicadores de disponibilidad

---

## Estimaciones y atributos de priorización

- **Puntos de historia:** 5
- **Prioridad:** Media
- **Dependencias:** 
  - HU-EP3-001, HU-EP3-002 (Registro de ventas)
  - HU-EP7-001 (Autenticación para control de acceso)
