# HU-EP7-004: Asignar operador a punto de venta

## Formato estándar

Como **administrador**, quiero **asignar operadores a puntos de venta específicos** para **permitirles registrar ventas y consultar inventario en esos puntos de venta**.

---

## Descripción

El sistema debe permitir a los administradores asignar operadores a uno o múltiples puntos de venta. Esta asignación determina a qué puntos de venta puede acceder un operador para realizar operaciones. Los administradores no requieren asignación ya que tienen acceso a todos los puntos de venta por defecto.

**Contexto de negocio:**
- Cada operador debe estar asignado al menos a un punto de venta para poder trabajar
- Un operador puede trabajar en múltiples puntos de venta (ej: cubrir turnos en diferentes tiendas)
- Las asignaciones pueden cambiar cuando los operadores se mueven entre puntos de venta
- Se debe mantener historial de asignaciones para auditoría

**Flujo de uso:**
1. Administrador accede a la gestión de usuarios o puntos de venta
2. Selecciona un operador
3. Visualiza los puntos de venta asignados actualmente
4. Selecciona puntos de venta adicionales o deselecciona existentes
5. Confirma los cambios
6. El sistema actualiza las asignaciones

---

## Criterios de Aceptación

### Escenario 1: Asignar operador a un punto de venta
**Dado que** soy un administrador autenticado  
**Y** existe un operador sin asignaciones  
**Y** existe un punto de venta activo  
**Cuando** asigno el operador al punto de venta  
**Entonces** el sistema crea el registro en `UserPointOfSale`  
**Y** `IsActive = true`  
**Y** `AssignedAt` se establece con la fecha/hora actual  
**Y** el operador puede acceder a ese punto de venta  
**Y** se muestra confirmación de asignación exitosa

### Escenario 2: Asignar operador a múltiples puntos de venta
**Dado que** soy un administrador autenticado  
**Y** existe un operador  
**Y** existen múltiples puntos de venta activos  
**Cuando** asigno el operador a varios puntos de venta simultáneamente  
**Entonces** el sistema crea múltiples registros en `UserPointOfSale`  
**Y** el operador puede acceder a todos los puntos de venta asignados  
**Y** se muestra confirmación con la lista de puntos de venta asignados

### Escenario 3: Desasignar operador de un punto de venta
**Dado que** un operador está asignado a un punto de venta  
**Cuando** desasigno al operador de ese punto de venta  
**Entonces** el sistema actualiza `IsActive = false` en `UserPointOfSale`  
**Y** `UnassignedAt` se establece con la fecha/hora actual  
**Y** el operador ya no puede acceder a ese punto de venta  
**Y** se mantiene el historial de la asignación (no se elimina físicamente)

### Escenario 4: Reasignar operador a punto de venta previamente desasignado
**Dado que** un operador fue desasignado de un punto de venta (registro con `IsActive = false`)  
**Cuando** lo reasigno al mismo punto de venta  
**Entonces** el sistema puede:
- Opción A: Actualizar el registro existente (`IsActive = true`, nuevo `AssignedAt`)
- Opción B: Crear un nuevo registro

**Y** el operador recupera acceso al punto de venta

### Escenario 5: Intentar asignar operador a punto de venta inactivo
**Dado que** existe un punto de venta con `IsActive = false`  
**Cuando** intento asignar un operador a ese punto de venta  
**Entonces** el sistema muestra un mensaje de advertencia: "No se puede asignar a un punto de venta inactivo"  
**Y** no se realiza la asignación  
**O** el sistema permite la asignación pero muestra advertencia (según regla de negocio)

### Escenario 6: Validar que operador tenga al menos una asignación
**Dado que** un operador tiene una única asignación activa  
**Cuando** intento desasignarlo de ese punto de venta  
**Entonces** el sistema muestra un mensaje: "Un operador debe tener al menos un punto de venta asignado"  
**Y** no se realiza la desasignación  
**O** el sistema permite la desasignación pero desactiva al operador (según regla de negocio)

### Escenario 7: Administradores no requieren asignación
**Dado que** existe un usuario con rol Administrador  
**Cuando** intento asignarlo a un punto de venta  
**Entonces** el sistema muestra un mensaje: "Los administradores tienen acceso a todos los puntos de venta y no requieren asignación"  
**Y** no se crea registro en `UserPointOfSale`  
**O** el sistema oculta la opción de asignación para administradores

### Escenario 8: Visualizar asignaciones actuales
**Dado que** soy un administrador  
**Cuando** visualizo un operador  
**Entonces** veo la lista de puntos de venta asignados activamente  
**Y** puedo ver el historial de asignaciones (fechas de asignación/desasignación)

---

## Notas adicionales

- **Reglas de negocio:**
  - Los administradores no deben aparecer en `UserPointOfSale` (acceso completo por lógica de aplicación)
  - Un operador debe tener al menos una asignación activa para poder trabajar
  - Las asignaciones deben validarse antes de permitir operaciones (registrar ventas, consultar inventario)

- **Historial:**
  - Mantener registros históricos en `UserPointOfSale` (no eliminar físicamente)
  - Usar `IsActive`, `AssignedAt` y `UnassignedAt` para trazabilidad

- **UX:**
  - Interfaz intuitiva: lista de puntos de venta con checkboxes o multi-select
  - Mostrar puntos de venta activos e inactivos con indicadores visuales
  - Confirmar cambios antes de aplicar

- **Validaciones:**
  - Verificar que el usuario es operador (no administrador)
  - Verificar que el punto de venta existe y está activo
  - Evitar asignaciones duplicadas (constraint único en `(UserId, PointOfSaleId)`)

---

## Tareas

1. **Backend - Dominio:**
   - Implementar servicio de asignaciones (`IUserPointOfSaleService`)
   - Implementar lógica de asignación/desasignación
   - Validar reglas de negocio (operador debe tener al menos una asignación)

2. **Backend - API:**
   - Crear endpoint `POST /api/users/{userId}/point-of-sales/{pointOfSaleId}` (asignar)
   - Crear endpoint `DELETE /api/users/{userId}/point-of-sales/{pointOfSaleId}` (desasignar)
   - Crear endpoint `GET /api/users/{userId}/point-of-sales` (listar asignaciones)
   - Verificar permisos (solo administradores)
   - Validar que usuario es operador

3. **Backend - Base de datos:**
   - Asegurar constraint único en `(UserId, PointOfSaleId)` en `UserPointOfSale`
   - Manejar excepciones de violación de constraints (asignación duplicada)

4. **Frontend - UI:**
   - Crear interfaz de gestión de asignaciones (multi-select o checkboxes)
   - Mostrar puntos de venta disponibles vs asignados
   - Indicadores visuales para puntos de venta activos/inactivos
   - Confirmación antes de aplicar cambios

5. **Frontend - Servicios:**
   - Crear servicio para gestión de asignaciones (`UserPointOfSaleService`)
   - Implementar llamadas a endpoints de asignación/desasignación
   - Manejar errores (asignación duplicada, punto de venta inactivo)

6. **Testing:**
   - Tests unitarios para servicio de asignaciones
   - Tests de integración para endpoints
   - Tests de validación de reglas de negocio
   - Tests de permisos (solo administradores)
   - Tests de constraint único

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de HU-EP7-001 (login), HU-EP7-002 (crear usuario), HU-EP8-001 (crear punto de venta)
  - Requiere tablas `User`, `PointOfSale` y `UserPointOfSale` en base de datos
  - Base para control de acceso en ventas e inventario

