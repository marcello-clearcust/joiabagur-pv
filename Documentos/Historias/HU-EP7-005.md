# HU-EP7-005: Desasignar operador de punto de venta

## Formato estándar

Como **administrador**, quiero **desasignar operadores de puntos de venta** para **restringir su acceso cuando cambian de ubicación o dejan de trabajar en ese punto de venta**.

---

## Descripción

El sistema debe permitir a los administradores desasignar operadores de puntos de venta específicos. Esta funcionalidad es complementaria a la asignación y permite gestionar cambios en las asignaciones de operadores. La desasignación debe mantener el historial sin eliminar físicamente los registros.

**Contexto de negocio:**
- Los operadores pueden cambiar de punto de venta cuando se rotan entre tiendas
- Puede ser necesario desasignar temporalmente un operador (vacaciones, baja médica)
- Se debe mantener historial de asignaciones para auditoría y reportes
- Un operador debe mantener al menos una asignación activa para poder trabajar

**Flujo de uso:**
1. Administrador accede a la gestión de asignaciones de un operador
2. Visualiza los puntos de venta asignados actualmente
3. Selecciona el punto de venta del cual desasignar
4. Confirma la desasignación
5. El sistema marca la asignación como inactiva y registra la fecha

---

## Criterios de Aceptación

### Escenario 1: Desasignar operador de un punto de venta exitosamente
**Dado que** soy un administrador autenticado  
**Y** un operador está asignado a un punto de venta  
**Cuando** desasigno al operador de ese punto de venta  
**Entonces** el sistema actualiza `IsActive = false` en `UserPointOfSale`  
**Y** `UnassignedAt` se establece con la fecha/hora actual  
**Y** el operador ya no puede acceder a ese punto de venta  
**Y** se muestra confirmación de desasignación exitosa  
**Y** el registro se mantiene en la base de datos (no se elimina físicamente)

### Escenario 2: Desasignar operador con múltiples asignaciones
**Dado que** un operador está asignado a 3 puntos de venta  
**Cuando** desasigno al operador de uno de los puntos de venta  
**Entonces** el sistema desasigna solo ese punto de venta  
**Y** el operador mantiene acceso a los otros 2 puntos de venta  
**Y** puede seguir trabajando normalmente

### Escenario 3: Intentar desasignar última asignación activa
**Dado que** un operador tiene solo una asignación activa  
**Cuando** intento desasignarlo de ese punto de venta  
**Entonces** el sistema muestra un mensaje: "Un operador debe tener al menos un punto de venta asignado. Asigne otro punto de venta antes de desasignar este."  
**Y** no se realiza la desasignación  
**O** el sistema permite la desasignación pero muestra advertencia y sugiere desactivar al operador (según regla de negocio)

### Escenario 4: Desasignar operador que ya está desasignado
**Dado que** un operador ya está desasignado de un punto de venta (`IsActive = false`)  
**Cuando** intento desasignarlo nuevamente  
**Entonces** el sistema muestra un mensaje informativo: "El operador ya está desasignado de este punto de venta"  
**Y** no se realiza ninguna acción adicional

### Escenario 5: Visualizar historial de desasignaciones
**Dado que** soy un administrador  
**Cuando** visualizo las asignaciones de un operador  
**Entonces** puedo ver tanto las asignaciones activas como las desasignaciones históricas  
**Y** veo las fechas de asignación (`AssignedAt`) y desasignación (`UnassignedAt`)

### Escenario 6: Reasignar después de desasignar
**Dado que** un operador fue desasignado de un punto de venta  
**Cuando** lo reasigno al mismo punto de venta  
**Entonces** el sistema puede:
- Opción A: Actualizar el registro existente (`IsActive = true`, nuevo `AssignedAt`)
- Opción B: Crear un nuevo registro

**Y** el operador recupera acceso al punto de venta

---

## Notas adicionales

- **Relación con HU-EP7-004:**
  - Esta historia puede estar integrada con HU-EP7-004 en una misma interfaz
  - La desasignación es esencialmente actualizar `IsActive = false` en `UserPointOfSale`
  - Considerar si mantener como historia separada o consolidar con HU-EP7-004

- **Reglas de negocio:**
  - Un operador debe tener al menos una asignación activa (validar antes de desasignar)
  - Las desasignaciones mantienen historial completo para auditoría
  - No eliminar físicamente registros de `UserPointOfSale`

- **UX:**
  - Confirmar desasignación antes de aplicar (especialmente si es la última asignación)
  - Mostrar advertencia si el operador tiene ventas recientes en ese punto de venta
  - Permitir desasignación masiva (múltiples puntos de venta a la vez)

- **Auditoría:**
  - Registrar `UnassignedAt` con timestamp preciso
  - Considerar registrar quién realizó la desasignación (Fase 2)

---

## Tareas

1. **Backend - Dominio:**
   - Extender servicio de asignaciones (`IUserPointOfSaleService`) con método de desasignación
   - Implementar validación: operador debe tener al menos una asignación activa
   - Implementar lógica de actualización de `IsActive = false` y `UnassignedAt`

2. **Backend - API:**
   - Crear o extender endpoint `DELETE /api/users/{userId}/point-of-sales/{pointOfSaleId}` (desasignar)
   - Verificar permisos (solo administradores)
   - Validar que la asignación existe y está activa
   - Validar regla de negocio (al menos una asignación activa)

3. **Backend - Base de datos:**
   - Actualizar `IsActive` y `UnassignedAt` en `UserPointOfSale`
   - No eliminar físicamente el registro

4. **Frontend - UI:**
   - Integrar funcionalidad de desasignación en interfaz de asignaciones (HU-EP7-004)
   - Botón o acción para desasignar de punto de venta específico
   - Confirmación antes de desasignar
   - Mostrar advertencia si es la última asignación activa

5. **Frontend - Servicios:**
   - Extender servicio de asignaciones con método `unassignUserFromPointOfSale`
   - Implementar llamada al endpoint de desasignación
   - Manejar errores (última asignación, asignación no encontrada)

6. **Testing:**
   - Tests unitarios para servicio de desasignación
   - Tests de integración para endpoint de desasignación
   - Tests de validación de regla de negocio (al menos una asignación)
   - Tests de permisos (solo administradores)

---

## Estimaciones y atributos de priorización

> **Nota:** Estas estimaciones deben completarse en una sesión de refinamiento con el equipo.

- **Puntos de historia (Story Points):** _Pendiente_
- **Impacto en usuario / Valor de negocio (1-5):** _Pendiente_
- **Urgencia (mercado / feedback) (1-5):** _Pendiente_
- **Complejidad / Esfuerzo (1-5):** _Pendiente_
- **Riesgos y dependencias:**
  - Depende de HU-EP7-004 (asignar operador)
  - Puede consolidarse con HU-EP7-004 en una sola historia/interfaz
  - Requiere tabla `UserPointOfSale` en base de datos

